steps:
  # Install dependencies
  - name: "gcr.io/cloud-builders/npm"
    id: install-dependencies
    args: ["install"]

  # Build function
  - name: "gcr.io/cloud-builders/npm"
    id: build-function
    args: ["run", "build"]

  # Deploy function
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: deploy-function
    args:
      - gcloud
      - beta
      - functions
      - deploy
      - ${_FUNCTION_NAME}
      - --entry-point=${_FUNCTION_ENTRY_POINT}
      - --region=${_REGION}
      - --source=.
      - --trigger-http
      - --runtime=${_RUNTIME}
      - --min-instances=1
      - --security-level=secure-always
      - --allow-unauthenticated

substitutions:
  _FUNCTION_NAME: stripe
  _FUNCTION_ENTRY_POINT: main
  _REGION: us-east4
  _RUNTIME: nodejs14
